#!/usr/bin/env bash

set -e

STATE_DIR="$HOME/.local/state/dot"
STATE_FILE="$HOME/.local/state/dot/installed_target"
TARGETS=( "arch-desktop" "arch-wsl" )
ADD_TARGETS=( "shared" "arch-desktop" "arch-wsl" )
export DOT_DIR="$HOME/dotfiles"

source $DOT_DIR/bin/cmds.sh

main(){
	if [[ $# -lt 1 ]]; then
		print_error "Missing command"
		print_usage_exit
	fi

	case $1 in
		help)
			print_usage_exit
			;;
		install)
			if  [[ $# -lt 2 ]] || ! contains "$2" "${TARGETS[@]}" ;then
				print_error "Missing or unknown target."
				print_usage_exit
			fi
			if [[ $(get_target) == "" ]]; then
				mkdir -p $STATE_DIR
				# install_target $2
				link_target $2
				echo -e "\033[32mDone!\033[0m"
				echo "installed_target=$2" > $STATE_FILE
			else
				echo -e "\033[33mWARNING:\033[0m Instalation detected."
				echo -en "Do you wish to reinstall? (\033[32mY\033[0m/\033[31mn\033[0m) "
				read input
				case $input in
					"" | "y")
						install_target $2
						link_target $2
						echo -e "\n\033[32mDone!\033[0m"
						rm $STATE_FILE
						echo "installed_target=$2" > $STATE_FILE
						;;
					*)
						exit 0
						;;
				esac
			fi
			;;
		targets)
			echo  "Targets: "
			echo -e "    \033[34march-desktop"
			echo -e "    arch-wsl\033[0m"
			;;
		update)
			if [[ $(get_target) == "" ]]; then
				print_error "Instalation not detected. Please install first."
				exit 1
			fi
			if [[ -d "$DOT_DIR/.git" ]]; then
				pushd $DOT_DIR/ 1>/dev/null
				echo -e "\033[32mDownloading latest changes...\033[0m"
				git fetch
				git pull origin main
				echo
				popd 1>/dev/null
			else
				print_error "Repository not found."
				exit 1
			fi

			link_target $(get_target)
			echo -e "\n\033[32mDone!\033[0m"
			;;
		push)
			if [[ -d "$DOT_DIR/.git" ]]; then
				pushd $DOT_DIR/ 1>/dev/null
				echo -e "\033[32mDownloading latest changes...\033[0m"
				git add .
				echo -e "\nInsira a mensagem de commit:"
				echo -en "\033[32m>> \033[0m"
				read msg
				git commit -m "$msg"
				git push origin main
				popd 1>/dev/null
			else
				print_error "Repository not found."
				exit 1
			fi
			;;
		add-link)
			if  [[ $# -lt 3 ]];then
				print_error "Missing arguments"
				print_usage_exit
			fi

			local target=$2
			local name=$3

			if ! contains "$target" "${ADD_TARGETS[@]}"; then
				print_error "Unknown target."
				exit 1
			fi

			if [ $# -gt 3 ]; then
				dest_path="$4/$name"
			else
				dest_path="\$HOME/.config/$name"
			fi

			if [ -d "$name" ]; then
				link_dir $target $name $dest_path
			elif [ -f "$name" ]; then
				link_file $target $name $dest_path
			else
				print_error "Could not add file or dir: \"$3\""
				exit 1
			fi

			;;
		add-pkg)
			echo "TODO: add-pkg"
			exit 0
			;;
		*)
			print_error "Unknown command."
			print_usage_exit 
			;;
	esac
}

main $@
